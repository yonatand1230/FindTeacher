<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Teacher</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script>
        // Sort Teachers func
        function sortTeachers(teachers) {
            var sorted = [];
            var rabbies = [];
            // remove "הרב" substring
            for (let i = 0; i < teachers.length; i++) {
                let teach = teachers[i];
                sorted.push(teach.replaceAll("הרב ", ""));
                if (teach.includes("הרב ")) {
                    rabbies.push(teach.replaceAll("הרב ", ""));
                }
            }
            sorted.sort();

            // re-add "הרב" after sorting
            rabbies.forEach(rav => {
                let rav_idx = sorted.indexOf(rav);
                sorted[rav_idx] = "הרב " + sorted[rav_idx]
            });

            return sorted;
        }
        function displayText(text) {
            let p = document.getElementById("text");
            p.innerHTML = text.replaceAll("\n","<br>");
        }

        function getCurrentClass(currentTime, schedule) {
            let [hours, minutes] = currentTime.split(':');
            hours = hours.length === 1 ? '0' + hours : hours; // pad with zeros
            minutes = minutes.length === 1 ? '0' + minutes : minutes;
            let formattedTime = `${hours}:${minutes}`; // put into a string again

            // get times
            let sortedTimes = Object.keys(schedule).sort((a, b) => {
                return new Date(`1970-01-01T${b}:00Z`) - new Date(`1970-01-01T${a}:00Z`);
            });

            // Find the class that started most recently but is still before or at the provided time
            let currentClass = "No class scheduled at this time";
            for (let time of sortedTimes) {
                if (formattedTime >= time) {
                    currentClass = schedule[time];
                    currentClass.time = time;
                    break;
                }
            }
            return currentClass;
        }

        function teacherSelected() {
            let select = document.getElementById("select-teacher");
            let teacher = select.value;
            let today = new Date();
            let todaySchedule = global_schedule[teacher][4]//[today.getDay()];
            console.log(todaySchedule)
            let time = `15:10` //`${today.getHours().toString().padStart(2,'0')}:${today.getMinutes().toString().padStart(2,'0')}`
            let current = getCurrentClass(time, todaySchedule);
            displayText(`נמצא שיעור:\n<u>מורה:</u> ${teacher}\n<u>חדר:</u> ${current.room}\n<u>מקצוע:</u> ${current.lesson}\n<u>שעה:</u> ${current.time}`);
        }

        let global_schedule;
        // Get Schedule
        let scheduleUrl = "https://raw.githubusercontent.com/yonatand1230/FindTeacher/refs/heads/main/schedule_2025.json"
        fetch(scheduleUrl)
            .then(response => {
                return response.json();
            })
            .then(schedule => {
                global_schedule = schedule;
                let options_source = Object.keys(schedule);
                options_source.splice(options_source.indexOf(""), 1);
                var options = sortTeachers(options_source);
                var options_html = [];
                options.forEach(opt => {
                    element = document.createElement("option");
                    element.value = opt;
                    element.innerHTML = opt;
                    select = document.getElementById("select-teacher");
                    select.appendChild(element);
                });
            })
            .then(opt_element => {
                select =
                    console.log(select)
            })
    </script>
</head>

<body>
    <div id="root">
        <div class="container mt-5">
            <div class="border p-4" style="border-color: blue;">
                <h2 dir="rtl" style="float: right">איתור מורה</h2>
                <div class="form-group">
                    <label style="float: right">בחירת מורה:          </label>
                    <select class="form-control" id="select-teacher" onchange="teacherSelected()">
                    </select>
                </div>
                <p id="text"></p>
            </div>
        </div>
    </div>
</body>
<html>